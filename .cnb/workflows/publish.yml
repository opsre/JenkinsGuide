main:
  push:
    - runner:
        cpus: 16
      services:
        - docker
        - git-clone-yyds
      imports:
        - https://cnb.cool/eryajf/build-env/-/blob/main/env.yaml
      docker:
        image: docker.cnb.cool/znb/images/node:18
        volumes:
          - /root/.npm:copy-on-write
          - /root/.pnpm:copy-on-write
      stages:
        - name: set env
          script: echo -n $(date "+%Y-%m-%d %H:%M:%S")
          exports:
            info: CUSTOM_ENV_DATE_INFO
        - name: ğŸ–¨ï¸ æ‰“å°ç¯å¢ƒ
          script: |
            node -v && npm -v && yarn -v && pnpm -v
        - name: ğŸ“¦ï¸ å®‰è£…ä¾èµ–
          script: |
            pnpm install
        - name: âš—ï¸ ç¼–è¯‘é¡¹ç›®
          script: |
            pnpm build
        - name: ğŸšš å‘å¸ƒåˆ¶å“
          image: tencentcom/rsync
          settings:
            user: ${SSH_USER}
            key: ${SSH_KEY}
            port: 2023
            hosts:
              - prod.eryajf.net
            source: docs/.vitepress/dist/
            target: /data/www/JenkinsGuide/
            delete: true
        - name: ğŸ”” å‘å¸ƒé€šçŸ¥
          image: tencentcom/dingtalk-bot-msg
          settings:
            c_type: "markdown" # æ”¯æŒ: text, markdown, link, actionCard, multiActionCard, feedCard
            secret: $DING_BOT_SECRET
            webhook: $DING_BOT_WEBHOOK
            isAtAll: true
            debug: false # æ–°å¢: æ˜¯å¦å¯ç”¨è°ƒè¯•æ¨¡å¼
            content: |
              > **ğŸ‰ JenkinsGuide åˆä¸€æ¬¡å‘å¸ƒå•¦ï¼**
              >
              > **æ„å»ºæ—¶é—´:** $CUSTOM_ENV_DATE_INFO
              >
              > **ä»“åº“åœ°å€:** [$CNB_REPO_SLUG]($CNB_REPO_URL_HTTPS)
              >
              > **æ„å»ºç”¨æˆ·:** $CNB_BUILD_USER
              >
              > **æäº¤ç”¨æˆ·:** $CNB_COMMITTER
              >
              > **æäº¤æ ‡é¢˜:** $CNB_COMMIT_MESSAGE_TITLE
              >
              > **æäº¤è¯¦æƒ…:** [${CNB_COMMIT_SHORT}](${CNB_EVENT_URL})
              >
              > **æ„å»ºæ—¥å¿—:** [æŸ¥çœ‹æ—¥å¿—]($CNB_BUILD_WEB_URL)
        
        - name: ğŸ§˜â€â™‚ï¸ åˆ·æ–°ç¼“å­˜
          image: docker.cnb.cool/znb/cdn-refresh
          settings:
            ak: "${TENCENT_OPSRE_AK}"
            sk: "${TENCENT_OPSRE_SK}"
            kind: "tencenteo"
            rtype: "path"
            domain: "opsre.top"
            urls:
              - "https://jenkinsguide.opsre.top/"